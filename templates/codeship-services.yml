web:
  build:
    context: .
    dockerfile_path: Dockerfile.codeship
  entrypoint: ./bin/docker/ruby_entrypoint
  environment:
    TEST_DATABASE_URL: 'postgres://postgres:@postgres:5432/shift_<%= app_name.gsub(/^shift-/,'') %>_test'
    REDIS_URL: 'redis://redis:6379'
    JWT_BOUNCER_SHARED_SECRET: 'localdevelopment'
    SELENIUM_URL: 'http://selenium:4444/wd/hub'
    MEMCACHE_SERVERS: 'memcached:11211'
    RAILS_ENV: test
  links:
    - postgres
    - redis
    - selenium
    - memcached
  depends_on:
    - postgres
    - redis
    - selenium
    - memcached
  cached: true
  volumes:
    - ./:/code
    - rubygems_cache:/rubygems
    - web_cache:/app/node_modules

postgres:
  image: postgres:9.6.2

redis:
  image: redis:3.2

selenium:
  image: selenium/standalone-chrome

memcached:
  image: memcached

yarn:
  build:
    context: .
    dockerfile: Dockerfile.yarn
  command: bash -c "npm rebuild node-sass && yarn run devserver"
  entrypoint: ./bin/docker/yarn_entrypoint
  environment:
    PORT: 4000
    API_HOST: 'http://web:3000'
  volumes:
    - .:/app
    - yarn_cache:/app/node_modules
